#!/usr/bin/env bash

set -eo pipefail

# Heroku has opinions on indentation, let's respect them
indent() {
  sed -u 's/^/       /'
}

BUILD_DIR=$1  # -> temp dir that contains whatever is in the git repo
CACHE_DIR=$2  # -> use this dir for caching between compiles
ENV_DIR=$3  # -> environment variables are stored as files inside here
INSTALL_DIR="$BUILD_DIR/.heroku/vendor/buildout"  # -> after buildout is
# finished, copy results to this dir so they get compressed into a Heroku slug
UI_URL=https://launchpad.net/plone/5.0/5.0/+download/Plone-5.0-UnifiedInstaller.tgz
UI_TARBALL=Plone-5.0-UnifiedInstaller.tgz
UI_DIR=Plone-5.0-UnifiedInstaller
PRECOMPILED_CACHE=https://github.com/webflowmeetplone/webflowmeetplone/releases/download/heroku-cheat-eggs/heroku-cheat-eggs.tgz
PRECOMPILED_TARBALL=heroku-cheat-eggs.tgz
APTSETUPSCRIPT=https://raw.githubusercontent.com/PlaythingBlog/plaything.core/master/templates/aptsetup

curl -OL $APTSETUPSCRIPT
bash aptsetup $BUILD_DIR $CACHE_DIR

# make sure dirs exist
mkdir -p $CACHE_DIR
mkdir -p $INSTALL_DIR

echo "-----> Use build cache"
if [ -d $CACHE_DIR/bin ]; then
    echo "Get buildout results from the previous build" | indent
    cp -r $CACHE_DIR/bin  $BUILD_DIR/
    cp -r $CACHE_DIR/eggs  $BUILD_DIR/
    cp -r $CACHE_DIR/parts  $BUILD_DIR/
    cp -r $CACHE_DIR/var  $BUILD_DIR/
else
    echo "Cache empty, let's fix that" | indent
    echo "Prime with Unified Installer cache" | indent
    curl -OL $UI_URL
    echo "Unpacking Installer" | indent
    tar xfz $UI_TARBALL
    cd $UI_DIR
    echo "Unpacking Installer cache" | indent
    tar xfj packages/buildout-cache.tar.bz2
    echo "Moving cache eggs to build directory" | indent
    cp -r buildout-cache/eggs $BUILD_DIR/
    echo "Clean up Installer files" | indent
    cd ..
    rm -rf $UI_TARBALL $UI_DIR
    echo "Get precompiled cache files"
    cd $BUILD_DIR
    curl -OL $PRECOMPILED_CACHE
    tar xfz $PRECOMPILED_TARBALL
    echo "Clean up precompiled installer file" | indent
    rm -rf $PRECOMPILED_TARBALL

fi

echo "-----> Read BUILDOUT_CFG from env vars, or use default"
if [ -f $ENV_DIR/BUILDOUT_CFG ]; then
    export "BUILDOUT_CFG=$(cat $ENV_DIR/BUILDOUT_CFG)"
    echo "Found ${BUILDOUT_CFG}" | indent
else
    export "BUILDOUT_CFG=heroku.cfg"
    echo "Using default: heroku.cfg" | indent
fi

echo "-----> Read BUILDOUT_VERBOSITY from env vars, or use default"
if [ -f $ENV_DIR/BUILDOUT_VERBOSITY ]; then
    export "BUILDOUT_VERBOSITY=$(cat $ENV_DIR/BUILDOUT_VERBOSITY)"
    echo "Use verbosity: ${BUILDOUT_VERBOSITY}" | indent
else
    export "BUILDOUT_VERBOSITY="
    echo "Use default buildout verbosity" | indent
fi

echo "-----> Read BOOTSTRAP_PY_URL from env vars, or use default"
if [ -f $ENV_DIR/BOOTSTRAP_PY_URL ]; then
    export "BOOTSTRAP_PY_URL=$(cat $ENV_DIR/BOOTSTRAP_PY_URL)"
    echo "Use custom bootstrap.py: ${BOOTSTRAP_PY_URL}" | indent
else
    export "BOOTSTRAP_PY_URL=https://bootstrap.pypa.io/bootstrap-buildout.py"
    echo "Use default bootstrap.py: ${BOOTSTRAP_PY_URL}" | indent
fi

echo "-----> Read ADMIN_PASSWORD from env vars, or use default"
if [ -f $ENV_DIR/ADMIN_PASSWORD ]; then
    export "ADMIN_PASSWORD=$(cat $ENV_DIR/ADMIN_PASSWORD)"
    echo "Use custom admin password: ${ADMIN_PASSWORD}" | indent
else
    export "ADMIN_PASSWORD=admin"
    echo "Use default admin password: ${ADMIN_PASSWORD}" | indent
fi
echo "-----> Set admin password"
sed "s|admin:admin|admin:${ADMIN_PASSWORD}|" heroku.cfg > heroku.cfg.new
mv heroku.cfg.new heroku.cfg

cd $BUILD_DIR
echo "-----> Bootstrap buildout"
curl -o bootstrap.py -L "${BOOTSTRAP_PY_URL}"
python bootstrap.py -c $BUILDOUT_CFG
echo "-----> Set admin password"
echo "-----> Run bin/buildout -c ${BUILDOUT_CFG} ${BUILDOUT_VERBOSITY}"
bin/buildout -c $BUILDOUT_CFG $BUILDOUT_VERBOSITY

echo "-----> Fix paths in zope.conf"
sed "s|${BUILD_DIR}|/app|" parts/instance/etc/zope.conf > zope.conf.new
mv zope.conf.new parts/instance/etc/zope.conf

echo "-----> Copy results to cache"
cp -r $BUILD_DIR/bin $CACHE_DIR
cp -r $BUILD_DIR/eggs $CACHE_DIR
cp -r $BUILD_DIR/parts $CACHE_DIR
cp -r $BUILD_DIR/var $CACHE_DIR

echo "-----> Copy results to slug"
cp -r $BUILD_DIR/bin $INSTALL_DIR
cp -r $BUILD_DIR/eggs $INSTALL_DIR
cp -r $BUILD_DIR/parts $INSTALL_DIR
cp -r $BUILD_DIR/var $INSTALL_DIR

echo "-----> Copy configure_zopeconf.py script to slug"
curl -ol "https://raw.githubusercontent.com/webflowmeetplone/webflowmeetplone/master/configure_zopeconf.py"
cp -r $build_dir/configure_zopeconf.py $install_dir

echo "Done" | indent
